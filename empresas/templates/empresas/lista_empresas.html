{% extends 'management/layout_management.html' %}

{% block content %}
<div class="container-fluid" id="listaEmpresas">
  <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">Cartera de <strong>Empresas</strong></h2>
      <a href="{% url 'empresas:crear_empresa' %}" class="btn btn-success">
          <i class="fa-solid fa-plus"></i> Nueva Empresa
      </a>
  </div>

  <form method="get" class="mb-4">
    <div class="input-group">
        <input type="text" name="busqueda" value="{{ filtros.busqueda }}" class="form-control" placeholder="Buscar por nombre, razón social o CIF...">
        <button class="btn btn-secondary" type="submit"><i class="fa-solid fa-search"></i></button>
        {% if filtros.busqueda %}
            <a href="{% url 'empresas:lista_empresas' %}" class="btn btn-outline-secondary">Limpiar</a>
        {% endif %}
    </div>
  </form>

  <div class="table-responsive mb-5">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>Empresa</th>
          <th>Contacto</th>
          <th>Comisión</th>
          <th>Alta</th>
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for empresa in empresas_activas %}
        <tr>
          <td>
              <strong>{{ empresa.nombre }}</strong><br>
              <small class="text-muted">{{ empresa.razon_social }}</small>
          </td>
          <td>
              {{ empresa.contacto_incidencias }}<br>
              <small class="text-muted">{{ empresa.email_incidencias }}</small>
          </td>
          <td>
              <span class="badge bg-info text-dark">{{ empresa.get_tipo_comision_display }}</span>
          </td>
          <td>{{ empresa.fecha_alta|date:"d/m/Y" }}</td>
          <td class="text-end">
            <a href="{% url 'empresas:detalle_empresa' empresa.id %}" class="btn btn-outline-info btn-sm" title="Ver Detalle"><i class="fa-solid fa-eye"></i></a>
            <a href="{% url 'empresas:editar_empresa' empresa.id %}" class="btn btn-outline-primary btn-sm" title="Editar"><i class="fa-solid fa-pen"></i></a>
            <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#desactivarModal{{ empresa.id }}" title="Desactivar"><i class="fa-solid fa-ban"></i></button>
          </td>
        </tr>

        <div class="modal fade" id="desactivarModal{{ empresa.id }}" tabindex="-1">
          <div class="modal-dialog">
              <div class="modal-content">
                  <form method="post" action="{% url 'empresas:desactivar_empresa' empresa.id %}">
                      {% csrf_token %}
                      <div class="modal-header">
                          <h5 class="modal-title">Desactivar Empresa</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                          ¿Estás seguro de desactivar a <strong>{{ empresa.nombre }}</strong>?<br>
                          <small>Quedará en el histórico pero no podrás asignarle nuevos casos.</small>
                      </div>
                      <div class="modal-footer">
                          <button type="submit" class="btn btn-warning">Desactivar</button>
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                      </div>
                  </form>
              </div>
          </div>
        </div>
        {% empty %}
        <tr><td colspan="5" class="text-center p-4">No hay empresas activas registradas.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if empresas_inactivas %}
  <h4 class="mt-5 text-muted">Histórico (Bajas)</h4>
  <div class="table-responsive">
    <table class="table table-secondary table-sm">
      <thead>
        <tr>
          <th>Empresa</th>
          <th>Fecha Baja</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for empresa in empresas_inactivas %}
        <tr>
          <td>{{ empresa.nombre }}</td>
          <td>{{ empresa.fecha_baja|date:"d/m/Y" }}</td>
          <td>
            <form method="post" action="{% url 'empresas:reactivar_empresa' empresa.id %}" class="d-inline">
                {% csrf_token %}
                <button class="btn btn-success btn-sm">Reactivar</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>
{% endblock %}