{% load static %}

<div class="crm-table-container border shadow-sm">

  <div class="container-fluid py-4">
            <div class="col-md-5 col-lg-5">
                <div class="d-flex w-100 align-items-center">
                    
                    <div class="d-flex flex-grow-1">
                        <div class="search-box w-100 position-relative">
                            <i class="fa-solid fa-search search-icon"></i>
                            <input type="text" id="globalSearch" value="{{ q }}" 
                                class="form-control ps-5" placeholder="Nombre, Tel o ID..."
                                style="border-top-right-radius: 0; border-bottom-right-radius: 0;"
                                onkeypress="if(event.key === 'Enter') aplicarFiltrosJS()">
                        </div>
                        <button class="btn btn-secondary" type="button" onclick="aplicarFiltrosJS()"
                                style="border-top-left-radius: 0; border-bottom-left-radius: 0; min-width: 80px;">
                            {% if hay_filtros_impagos %}
                                <i class="fa-solid fa-check"></i> {% else %}
                                Buscar
                            {% endif %}
                        </button>
                    </div>

                    <div class="d-flex ms-2 gap-1">
                        {% if hay_filtros_impagos %}
                            <a href="{% url 'crm:dashboard_crm' empresa.id %}" class="btn btn-danger shadow-sm" title="Limpiar y Cerrar Filtros">
                                <i class="fa-solid fa-trash-can"></i>
                            </a>
                        {% else %}
                            <button type="button" id="btnToggleFiltros" class="btn btn-outline-primary shadow-sm" 
                                    onclick="toggleFiltros()" title="Mostrar filtros por columna">
                                <i class="fas fa-filter"></i>
                            </button>
                            
                            <button type="button" id="btnAplicarCheck" class="btn btn-outline-success shadow-sm" 
                                    onclick="aplicarFiltrosJS()" style="display: none;">
                                <i class="fa-solid fa-check"></i>
                            </button>
                        {% endif %}
                    </div>

                </div>
            </div>
    </div>     

<table class="table table-hover align-middle mb-0 table-crm" id="tablaExpedientes">
        
        <thead class="bg-light sticky-top" style="z-index: 100;">
            <tr class="text-center small text-uppercase text-muted">
                <th class="col-agente">Agente</th>
                <th class="col-id">ID</th>
                <th class="col-nombre" style="min-width: 180px;">Nombre y Apellido</th>
                <th class="col-tel">Teléfono</th>
                
                <th class="col-tipo">Tipo</th>
                <th class="col-monto text-center">Total Orig.</th>
                <th class="col-cuota text-center">Cuotas</th>
                <th class="col-fecha text-center">F. Compra</th>
                <th class="col-fecha text-center">F. Impago</th>
                <th class="col-dias text-center">Días</th>
                
                <th class="col-comentario">Comentario</th>
                <th class="col-estado">Estado</th>
                <th class="col-monto text-center text-danger">Deuda</th>
                <th class="col-monto text-center text-success">Pagado</th>

                <th class="col-tic text-center">W1</th>
                <th class="col-tic text-center">L1</th>
                <th class="col-tic text-center">W2</th>
                <th class="col-tic text-center">L2</th>
                <th class="col-tic text-center">W3</th>
                <th class="col-tic text-center">L3</th>
                <th class="col-tic text-center">W4</th>
                <th class="col-tic text-center">L4</th>
                <th class="col-tic text-center">W5</th>   <th class="col-tic text-center">L5</th>   <th class="col-tic text-center">BE</th>   <th class="col-tic text-center">BR</th>   <th class="col-tic text-center">LLB</th>  <th class="col-tic text-center">ASNEF</th>
                <th class="col-tic text-center">LLA</th>  <th class="col-fecha text-center">Último Msj</th>
                <th class="col-fecha text-center">F. Pago/Prom.</th>
                <th class="col-acciones text-center" style="min-width: 150px;">Acciones</th>
            </tr>
        </thead>

        <tbody>
            {% now "Y-m-d" as hoy %}

            {% for exp in impagos %}
            <tr id="fila-exp-{{ exp.id }}" 
                class="text-center {% if exp.causa_impago == 'PAGARA' and exp.fecha_pago_promesa %}{% if exp.fecha_pago_promesa|date:'Y-m-d' == hoy %}row-promesa-hoy{% elif exp.fecha_pago_promesa|date:'Y-m-d' < hoy %}row-promesa-vencida{% endif %}{% endif %}">
                
                <td class="col-agente">
                    <select class="form-select form-select-sm fw-bold small text-muted"
                            onchange="cambiarAgente(this, {{ exp.id }})"
                            style="cursor: pointer; border: 1px solid #dee2e6;"
                            {% if not user.is_staff %}disabled{% endif %}>
                        <option value="" {% if not exp.agente %}selected{% endif %}>- Sin Asignar -</option>
                        {% for agente in agentes_disponibles %}
                            <option value="{{ agente.id }}" {% if exp.agente and exp.agente.id == agente.id %}selected{% endif %}>
                                {{ agente.username }}
                            </option>
                        {% endfor %}
                    </select>
                </td>

                <td class="col-id small fw-bold text-primary">{{ exp.numero_expediente }}</td>
                <td class="col-nombre fw-bold">{{ exp.deudor_nombre }}</td>
                <td class="col-tel small">{{ exp.deudor_telefono }}</td>
                <td class="col-tipo"><span class="badge bg-light text-dark border">{{ exp.tipo_producto }}</span></td>
                <td class="col-monto text-center small">{{ exp.monto_original }} €</td>
                <td class="col-cuota text-center small">{{ exp.cuotas_totales }}</td>
                <td class="col-fecha text-center small">{{ exp.fecha_compra|date:"d/m/y"|default:"-" }}</td>
                <td class="col-fecha text-center small">{{ exp.fecha_impago|date:"d/m/y" }}</td>
                
                <td class="col-dias text-center">
                    {% if exp.tiempo_en_impago > 0 %}
                        <span class="badge rounded-pill {% if exp.tiempo_en_impago > 60 %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                            {{ exp.tiempo_en_impago }}
                        </span>
                    {% else %}
                        <span class="text-muted small">-</span>
                    {% endif %}
                </td>

                <td class="col-comentario" style="min-width: 200px;"> 
                    
                    <div class="d-flex w-100 gap-1 align-items-center">
                        
                        <select class="form-select form-select-sm small text-muted text-truncate flex-grow-1" 
                                onchange="actualizarComentario(this, {{ exp.id }})"
                                style="border: 1px solid #dee2e6;">
                            <option value="" {% if not exp.comentario_estandar %}selected{% endif %}>- Sin Obs. -</option>
                            {% for val, text in exp.OPCIONES_COMENTARIO %}
                            <option value="{{ val }}" {% if exp.comentario_estandar == val %}selected{% endif %}>{{ text }}</option>
                            {% endfor %}
                        </select>

                        <button type="button" 
                                class="btn btn-sm {% if exp.comentarios %}btn-warning text-dark border-warning{% else %}btn-outline-secondary border-0{% endif %}" 
                                data-bs-toggle="modal" 
                                data-bs-target="#modalNota-{{ exp.id }}"
                                style="width: 32px; height: 31px; display: flex; align-items: center; justify-content: center;"
                                title="{% if exp.comentarios %}Ver Nota{% else %}Agregar Nota{% endif %}">
                            <i class="fa-regular fa-comment-dots"></i>
                        </button>
                    </div>
                </td>

                <td class="col-estado">
                    <span id="estado-texto-{{ exp.id }}" class="badge bg-white text-dark border shadow-sm">
                        {{ exp.get_causa_impago_display|default:"PENDIENTE" }}
                    </span>
                </td>
                
                <td class="col-monto text-center fw-bold text-danger">{{ exp.monto_actual }} €</td>
                <td class="col-monto text-center fw-bold text-success">{{ exp.monto_recuperado|default:"0.00" }} €</td>
                
                {% include 'crm/includes/tics_seguimiento.html' with exp=exp %}

                <td class="col-fecha text-center small text-muted">
                    <span id="fecha-ult-{{ exp.id }}">
                        {{ exp.ultimo_mensaje_fecha|date:"d/m/Y"|default:"-" }}
                    </span>
                </td>

                <td class="col-fecha text-center small text-success fw-bold">
                    <span id="fecha-pago-{{ exp.id }}">
                        {% if exp.causa_impago == 'PAGARA' or exp.estado == 'PAGARA' %}
                            {{ exp.fecha_pago_promesa|date:"d/m/Y"|default:"-" }}
                        {% else %}-{% endif %}
                    </span>
                </td>

                <td class="col-acciones bg-white">
                    <div class="d-flex gap-1 justify-content-center">
                        <button type="button" class="btn btn-sm btn-outline-success btn-action-crm" 
                                title="Registrar Pago" 
                                data-bs-toggle="modal" 
                                data-bs-target="#modalPago-{{ exp.id }}">
                            <i class="fa-solid fa-sack-dollar"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-warning btn-action-crm" 
                                title="Documentación" data-bs-toggle="modal" 
                                data-bs-target="#modalDocs{{ exp.id }}">
                            <i class="fa-solid fa-folder-open"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary btn-action-crm" 
                                data-bs-toggle="modal" data-bs-target="#modalEditar-{{ exp.id }}" 
                                title="Editar Cliente">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                        <a href="{% url 'crm:detalle_expediente' exp.id %}" class="btn btn-sm btn-outline-primary btn-action-crm" title="Ver Detalle">
                            <i class="fa-solid fa-eye"></i>
                        </a>
                        <button type="button" class="btn btn-sm btn-outline-danger btn-action-crm" 
                                title="Mover a Papelera" data-bs-toggle="modal" 
                                data-bs-target="#modalPapelera{{ exp.id }}">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>


            {% include 'crm/includes/modal_nota_interna.html' with exp=exp %}
            {% include 'crm/includes/modal_documentacion.html' with exp=exp %}
            {% include 'crm/includes/modal_editar_registro.html' with exp=exp %}
            {% include 'crm/includes/modal_registrar_pago.html' with exp=exp %}
            {% include 'crm/includes/modal_desactivar.html' with exp=exp %}

            {% endfor %}

        </tbody>
    </table>
</div>



