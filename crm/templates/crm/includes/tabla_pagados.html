<div class="crm-table-container border shadow-sm pb-3">
    
    <div class="container-fluid py-4 pb-2">
        <div class="col-md-5 col-lg-5">
            <div class="d-flex w-100 align-items-center">
                <div class="d-flex flex-grow-1">
                    <div class="search-box w-100 position-relative">
                        <i class="fa-solid fa-search search-icon"></i>
                        <input type="text" id="globalSearchPagados" value="{{ q }}" 
                            class="form-control ps-5" placeholder="Nombre, Tel o ID..."
                            style="border-top-right-radius: 0; border-bottom-right-radius: 0;"
                            onkeypress="if(event.key === 'Enter') aplicarFiltrosJS()">
                    </div>
                    <button class="btn btn-secondary" type="button" onclick="aplicarFiltrosJS()"
                            style="border-top-left-radius: 0; border-bottom-left-radius: 0; min-width: 80px;">
                        {% if q %}<i class="fa-solid fa-check"></i>{% else %}Buscar{% endif %}
                    </button>
                </div>
                <div class="d-flex ms-2 gap-1">
                    {% if q %}
                        <a href="{% url 'crm:dashboard_crm' empresa.id %}?tab=ha-pagado" class="btn btn-danger shadow-sm" title="Limpiar Búsqueda">
                            <i class="fa-solid fa-trash-can"></i>
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div> 

    {% if empresa.crm_config.tiene_cedidos %}
    <div class="px-3 mb-3">
        <ul class="nav nav-pills" id="pills-pagados-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active btn-sm px-4 border" data-bs-toggle="pill" data-bs-target="#pills-pagados-impagos" type="button">
                    <i class="fa-solid fa-file-circle-exclamation me-2"></i>Impagos
                    <span class="badge bg-white text-dark ms-2 border">{{ pagados_impagos.count }}</span>
                </button>
            </li>
            <li class="nav-item ms-2" role="presentation">
                <button class="nav-link btn-sm px-4 border" data-bs-toggle="pill" data-bs-target="#pills-pagados-cedidos" type="button">
                    <i class="fa-solid fa-circle-exclamation me-2"></i>Cedidos
                    <span class="badge bg-white text-dark ms-2 border">{{ pagados_cedidos.count }}</span>
                </button>
            </li>
        </ul>
    </div>
    {% endif %}

    <div class="tab-content">
        <div class="tab-pane fade show active" id="pills-pagados-impagos" role="tabpanel">
            <table class="table table-hover align-middle mb-0 table-crm">
                <thead class="bg-light sticky-top" style="z-index: 100;">
                    <tr class="text-center small text-uppercase text-muted">
                        <th class="col-agente">Agente</th>
                        <th class="col-id">ID</th>
                        <th class="col-nombre" style="min-width: 180px;">Nombre y Apellido</th>
                        <th class="col-monto text-center">Total Orig.</th>
                        <th class="col-monto text-center text-success">Pagado Real</th>
                        <th class="col-monto text-center text-warning">Desc.</th> 
                        <th class="col-fecha text-center">F. Cierre</th> 
                        <th class="col-acciones text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for exp in pagados_impagos %}
                        <tr id="fila-pagado-{{ exp.id }}" class="text-center table-success table-striped align-middle" style="--bs-table-bg-type: solid; --bs-table-bg: rgba(25, 135, 84, 0.05);">
                            <td class="col-agente text-muted small fw-medium">{{ exp.agente.username|default:"- Sin Asignar -" }}</td>
                            <td class="col-id small fw-bold text-success">{{ exp.numero_expediente }}</td>
                            <td class="col-nombre fw-bold text-dark">{{ exp.deudor_nombre }}</td>
                            <td class="col-monto text-center small text-muted text-decoration-line-through">{{ exp.monto_original }} €</td>
                            <td class="col-monto text-center fw-bold text-success"><i class="fa-solid fa-check-circle me-1 small"></i>{{ exp.monto_recuperado|default:"0.00" }} €</td>
                            <td class="col-monto text-center fw-bold text-warning">
                                {% with descuento=exp.get_descuento_acumulado %}{% if descuento > 0 %}-{{ descuento }} €{% else %}-{% endif %}{% endwith %}
                            </td>
                            <td class="col-fecha text-center small text-success fw-bold">{{ exp.pagos.first.fecha_pago|date:"d/m/y"|default:"-" }}</td>
                            <td class="col-acciones bg-transparent">
                                <div class="d-flex gap-1 justify-content-center">
                                    <button type="button" class="btn btn-sm btn-outline-warning" title="Documentación" data-bs-toggle="modal" data-bs-target="#modalDocsPagados{{ exp.id }}"><i class="fa-solid fa-folder-open"></i></button>
                                    <a href="{% url 'crm:detalle_expediente' exp.id %}" class="btn btn-sm btn-outline-primary" title="Ver Detalle"><i class="fa-solid fa-eye"></i></a>
                                    <button type="button" class="btn btn-sm btn-outline-danger" title="Mover a Papelera" data-bs-toggle="modal" data-bs-target="#modalPapeleraPagados{{ exp.id }}"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                        
                        {% empty %}
                        <tr><td colspan="8" class="text-center py-5"><div class="text-success opacity-50 mb-3"><i class="fa-solid fa-clipboard-check" style="font-size: 3rem;"></i></div><h6 class="fw-bold text-muted mb-0">No hay impagos recuperados.</h6></td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if empresa.crm_config.tiene_cedidos %}
        <div class="tab-pane fade" id="pills-pagados-cedidos" role="tabpanel">
            <table class="table table-hover align-middle mb-0 table-crm">
                <thead class="bg-light sticky-top" style="z-index: 100;">
                    <tr class="text-center small text-uppercase text-muted">
                        <th class="col-agente">Agente</th>
                        <th class="col-id">ID</th>
                        <th class="col-nombre" style="min-width: 180px;">Nombre y Apellido</th>
                        <th class="col-monto text-center">Monto Acelerado</th>
                        <th class="col-monto text-center text-success">Pagado Real</th>
                        <th class="col-fecha text-center">F. Cesión</th>
                        <th class="col-fecha text-center">F. Cierre</th> 
                        <th class="col-acciones text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for exp in pagados_cedidos %}
                        <tr id="fila-pagado-ced-{{ exp.id }}" class="text-center table-warning table-striped align-middle" style="--bs-table-bg-type: solid; --bs-table-bg: rgba(255, 193, 7, 0.05);">
                            <td class="col-agente text-muted small fw-medium">{{ exp.agente.username|default:"- Sin Asignar -" }}</td>
                            <td class="col-id small fw-bold text-warning">{{ exp.numero_expediente }}</td>
                            <td class="col-nombre fw-bold text-dark">{{ exp.deudor_nombre }}</td>
                            <td class="col-monto text-center small text-muted">{{ exp.monto_original }} €</td>
                            <td class="col-monto text-center fw-bold text-success"><i class="fa-solid fa-check-circle me-1 small"></i>{{ exp.monto_recuperado|default:"0.00" }} €</td>
                            <td class="col-fecha text-center small text-muted">{{ exp.fecha_cesion|date:"d/m/y"|default:"-" }}</td>
                            <td class="col-fecha text-center small text-success fw-bold">{{ exp.pagos.first.fecha_pago|date:"d/m/y"|default:"-" }}</td>
                            <td class="col-acciones bg-transparent">
                                <div class="d-flex gap-1 justify-content-center">
                                    <button type="button" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalDocsPagados{{ exp.id }}"><i class="fa-solid fa-folder-open"></i></button>
                                    <a href="{% url 'crm:detalle_expediente' exp.id %}" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-eye"></i></a>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="8" class="text-center py-5"><div class="text-warning opacity-50 mb-3"><i class="fa-solid fa-file-signature" style="font-size: 3rem;"></i></div><h6 class="fw-bold text-muted mb-0">No hay cedidos recuperados.</h6></td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>