{% extends 'management/layout_management.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            
            <div class="d-flex justify-content-between mb-4 align-items-center mt-2">
                <div class="col-md-4">
                    <h3 class="fw-bold mb-0 text-dark">{{ empresa.nombre }} <span class="text-muted fs-6">| CRM</span></h3>
                </div>
                
                <div class="col-md-3 text-end">
                    <button class="btn btn-primary btn-sm px-3 shadow-sm"><i class="fa-solid fa-file-import me-1"></i> Importar Excel</button>
                    <button class="btn btn-success btn-sm px-3 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalNuevoRegistro">
                        <i class="fa-solid fa-plus me-1"></i> Nuevo Registro
                    </button>
                </div>
            </div>

            <ul class="nav nav-tabs border-0" id="crmTab" role="tablist">
                <li class="nav-item">
                    <button class="nav-link {% if tab_activa == 'impagos' %}active{% endif %} fw-bold" 
                            id="impagos-tab" data-bs-toggle="tab" data-bs-target="#tab-impagos" type="button">
                        Impagos
                    </button>
                </li>
                {% if empresa.crm_config.tiene_cedidos %}
                <li class="nav-item">
                    <button class="nav-link {% if tab_activa == 'cedidos' %}active{% endif %} fw-bold" 
                            id="cedidos-tab" data-bs-toggle="tab" data-bs-target="#tab-cedidos" type="button">
                        Cedidos
                    </button>
                </li>
                {% endif %}
                <li class="nav-item">
                    <button class="nav-link {% if tab_activa == 'recobros' %}active{% endif %} fw-bold" 
                            id="recobros-tab" data-bs-toggle="tab" data-bs-target="#tab-recobros" type="button">
                        REG_Recobros
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link {% if tab_activa == 'ha-pagado' %}active{% endif %} fw-bold" 
                            id="ha-pagado-tab" data-bs-toggle="tab" data-bs-target="#tab-ha-pagado" type="button">
                        Ha Pagado
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link {% if tab_activa == 'info-empresa' %}active{% endif %} fw-bold" 
                            id="info-empresa-tab" data-bs-toggle="tab" data-bs-target="#tab-info-empresa" type="button">
                        Info Empresa
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link {% if tab_activa == 'papelera' %}active{% endif %} fw-bold text-danger" 
                            id="papelera-tab" data-bs-toggle="tab" data-bs-target="#tab-papelera" type="button">
                        <i class="fa-solid fa-trash-can me-1"></i> Papelera
                    </button>
                </li>
            </ul>
            
            <div class="tab-content border-0" id="crmTabContent">
                
                <div class="tab-pane fade {% if tab_activa == 'impagos' %}show active{% endif %}" id="tab-impagos" role="tabpanel">
                    {% include 'crm/includes/tabla_impagos.html' %}
                </div>
                
                {% if empresa.crm_config.tiene_cedidos %}
                <div class="tab-pane fade {% if tab_activa == 'cedidos' %}show active{% endif %}" id="tab-cedidos" role="tabpanel">
                    {% include 'crm/includes/tabla_cedidos.html' %}
                </div>
                {% endif %}
                
                <div class="tab-pane fade {% if tab_activa == 'recobros' %}show active{% endif %}" id="tab-recobros" role="tabpanel">
                    {% include 'crm/includes/tabla_recobros.html' %}
                </div>

                <div class="tab-pane fade {% if tab_activa == 'ha-pagado' %}show active{% endif %}" id="tab-ha-pagado" role="tabpanel">
                    {% include 'crm/includes/tabla_pagados.html' %}
                </div>

                <div class="tab-pane fade {% if tab_activa == 'info-empresa' %}show active{% endif %}" id="tab-info-empresa" role="tabpanel">
                    {% include 'crm/includes/info_empresa.html' %}
                </div>

                <div class="tab-pane fade {% if tab_activa == 'papelera' %}show active{% endif %}" id="tab-papelera" role="tabpanel">
                    {% include 'crm/includes/tabla_papelera.html' %}
                </div>
             </div>
        </div>
    </div>
</div>


{% include 'crm/includes/modal_nuevo_registro.html' %}
{% include 'crm/includes/modal_confirmar_fecha.html' %}
{% include 'crm/includes/modal_eliminar_doc.html' %}

{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/CRM/seguimiento.js' %}"></script>
    <script src="{% static 'js/CRM/autocompletado.js' %}"></script>
    <script src="{% static 'js/CRM/crm_list.js' %}"></script> 
    <script src="{% static 'js/CRM/validarPago.js' %}"></script>
    <script src="{% static 'js/CRM/eliminarDoc.js' %}"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // 1. Inicializar Popovers
            var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
            var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl, {
                    trigger: 'hover',
                    html: true,
                    customClass: 'crm-popover'
                })
            });

            // 2. Activar Pestaña Correcta (Persistencia)
            // Tomamos la variable tab_activa que enviamos desde el backend
            const tabName = "{{ tab_activa|default:'impagos' }}"; 
            
            // Buscamos el botón por el ID que acabamos de crear (ej: recobros-tab)
            const triggerEl = document.querySelector(`#${tabName}-tab`);
            
            if (triggerEl) {
                const tabInstance = new bootstrap.Tab(triggerEl);
                tabInstance.show();
            }
        });
    </script>
{% endblock %}